<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
        name="viewport">
  <meta content="ie=edge" http-equiv="X-UA-Compatible">
  <link href="style.css" rel="stylesheet">
  <title>Document</title>
</head>
<body>
<div id="test">
  Hello <strong>World</strong>!
</div>

<div id="root"></div>

<script>
  const el = document.getElementById('test')

  debugger

  // ===========================
  const api = {
    get(url) {
      switch (url) {
        case '/lots': {
          return new Promise((resolve) => {
            setTimeout(() => {
              const demoLots = [
                {
                  id: 1,
                  title: 'Apple',
                  price: 16,
                  description: 'Apple description'
                },
                {
                  id: 2,
                  title: 'Orange',
                  price: 41,
                  description: 'Orange description'
                }
              ]

              resolve(demoLots)
            }, 1000)
          })
        }
      }
    }
  }

  const stream = {
    subscribe(channel, callback) {
      const match = /price-(\d+)/.exec(channel)
      if (match) {
        setInterval(() => {
          const id = parseInt(match[1])
          const price = Math.floor(Math.random() * 100)

          callback({id, price})
        }, 2000)
      }
    }
  }

  // ===========================

  let state = {
    time: new Date(),
    lots: null
  }

  // ===========================

  function App({state}) {
    const app = document.createElement('div')
    app.className = ('app')
    app.append(Header())
    app.append(Clock({time: state.time}))
    app.append(Lots({lots: state.lots}))

    return app
  }

  function Header() {
    const header = document.createElement('header')
    const title = document.createElement('h1')
    title.innerText = 'Title'

    header.append(title)
    header.append(Logo())

    return header
  }

  function Logo() {
    const image = document.createElement('img')
    image.src = 'react.png'
    image.alt = 'logo'

    return image
  }

  function Clock({time}) {
    const timer = document.createElement('div')
    timer.className = 'timer'
    const value = document.createElement('span')
    value.className = 'value'
    value.innerText = time.toLocaleTimeString()

    timer.append(value)

    const icon = document.createElement('span')
    if (time.getHours() > 7 && time.getHours() < 21) {
      icon.className = 'icon day'
    } else {
      icon.className = 'icon night'
    }

    timer.append(icon)

    return timer
  }

  function Lots({lots}) {
    if (lots === null) {
      return Loader()
    }

    const list = document.createElement('div')
    list.className = 'lots'

    lots.forEach(lot => {
      list.append(Lot({lot}))
    })

    return list
  }

  function Lot({lot}) {
    const node = document.createElement('section')
    node.className = 'lot'

    const lotTitle = document.createElement('h2')
    lotTitle.className = 'lot-title'

    const lotTitleName = document.createElement('span')
    lotTitleName.innerText = lot.title

    const lotTitlePrice = document.createElement('span')
    lotTitlePrice.innerText = lot.price

    lotTitle.append(lotTitleName, lotTitlePrice)

    const lotDescription = document.createElement('p')
    lotDescription.innerText = lot.description

    node.append(lotTitle, lotDescription)

    return node
  }

  function Loader() {
    const loader = document.createElement('div')
    loader.className = 'loader'
    loader.innerText = 'Loading...'

    return loader
  }

  // ===========================

  function renderView(state) {
    render(App({state}), document.getElementById('root'))
  }

  renderView(state)

  // ===========================

  setInterval(() => {
    state = {
      ...state,
      time: new Date()
    }

    renderView(state)
  }, 1000)

  function onPrice(data) {
    const updatedLots = state.lots.map(lot => {
      if (lot.id !== data.id) return lot

      return {
        ...lot,
        price: data.price
      }
    })

    state = {
      ...state,
      lots: updatedLots
    }

    renderView(state)
  }

  api.get('/lots').then(lots => {
    state = {
      ...state,
      lots
    }

    renderView(state)

    state.lots.forEach(lot => {
      stream.subscribe(`price-${lot.id}`, onPrice)
    })
  })

  // ===========================

  function render(virtualDom, realDomRoot) {
    const virtualDomRoot = document.createElement(realDomRoot.tagName)
    virtualDomRoot.id = realDomRoot.id
    virtualDomRoot.append(virtualDom)

    sync(virtualDomRoot, realDomRoot)
  }

  function sync(virtualNode, realNode) {
    if (virtualNode.id !== realNode.id) {
      realNode.id = virtualNode.id
    }

    if (virtualNode.className !== realNode.className) {
      realNode.className = virtualNode.className
    }

    if (virtualNode.attributes) {
      Array.from(virtualNode.attributes).forEach((attr) => {
        realNode[attr.name] = attr.value
      })
    }

    if (virtualNode.nodeValue !== realNode.nodeValue) {
      realNode.nodeValue = virtualNode.nodeValue
    }

    realNode.innerHTML = ''

    const virtualDomChildren = virtualNode.childNodes

    for (let i = 0; i < virtualDomChildren.length; i++) {
      const innerVirtualNode = virtualDomChildren[i]

      let newRealNode
      if (innerVirtualNode.nodeType === Node.TEXT_NODE) {
        newRealNode = document.createTextNode('')
      } else {
        newRealNode = document.createElement(innerVirtualNode.tagName)
      }
      sync(innerVirtualNode, newRealNode)
      realNode.append(newRealNode)
    }
  }

  // ===========================

</script>

</body>
</html>