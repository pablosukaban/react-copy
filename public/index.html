<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
      name="viewport"
    />
    <meta content="ie=edge" http-equiv="X-UA-Compatible" />
    <link href="style.css" rel="stylesheet" />
    <script src="https://unpkg.com/react@16/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
    <title>What is React</title>
  </head>
  <body>
    <div id="root"></div>

    <script>
      const api = {
        get(url) {
          switch (url) {
            case '/lots': {
              return new Promise((resolve) => {
                setTimeout(() => {
                  const demoLots = [
                    {
                      id: 1,
                      title: 'Apple',
                      price: 16,
                      description: 'Apple description',
                    },
                    {
                      id: 2,
                      title: 'Orange',
                      price: 41,
                      description: 'Orange description',
                    },
                  ];

                  resolve(demoLots);
                }, 1000);
              });
            }
          }
        },
      };

      const stream = {
        subscribe(channel, callback) {
          const match = /price-(\d+)/.exec(channel);
          if (match) {
            setInterval(() => {
              const id = parseInt(match[1]);
              const price = Math.floor(Math.random() * 100);

              callback({ id, price });
            }, 2000);
          }
        },
      };

      // ===========================

      let state = {
        time: new Date(),
        lots: null,
      };

      // ===========================

      function App({ state }) {
        return React.createElement('div', { className: 'app' }, [
          React.createElement(Header, { key: 'header' }),
          React.createElement(Clock, { time: state.time, key: 'clock' }),
          React.createElement(Lots, { lots: state.lots, key: 'lots' }),
        ]);
      }

      function Header() {
        return React.createElement(
          'header',
          {
            className: 'header',
          },
          React.createElement(Logo)
        );
      }

      function Logo() {
        return React.createElement('img', { src: 'react.png', alt: 'logo' });
      }

      function Clock({ time }) {
        const isDay = time.getHours() > 7 && time.getHours() < 21;

        return React.createElement(
          'div',
          { className: 'timer' },
          React.createElement(
            'span',
            { className: 'value' },
            time.toLocaleTimeString()
          ),
          React.createElement('span', {
            className: `icon ${isDay ? 'day' : 'night'}`,
          })
        );
      }

      function Lots({ lots }) {
        if (lots === null) {
          return React.createElement(Loader);
        }

        return React.createElement(
          'div',
          { className: 'lots' },
          lots.map((lot) => React.createElement(Lot, { lot, key: lot.id }))
        );
      }

      function Lot({ lot }) {
        return React.createElement(
          'section',
          { className: 'lot' },
          React.createElement('h2', { className: 'lot-title' }, [
            React.createElement('span', { key: 'title' }, lot.title),
            React.createElement('span', { key: 'price' }, lot.price),
          ]),
          React.createElement('p', { key: 'description' }, lot.description)
        );
      }

      function Loader() {
        return React.createElement(
          'div',
          { className: 'loader' },
          'Loading...'
        );
      }

      // ===========================

      function renderView(state) {
        ReactDOM.render(
          React.createElement(App, { state }),
          document.getElementById('root')
        );
      }

      renderView(state);

      // ===========================

      setInterval(() => {
        state = {
          ...state,
          time: new Date(),
        };

        renderView(state);
      }, 1000);

      function onPrice(data) {
        const updatedLots = state.lots.map((lot) => {
          if (lot.id !== data.id) return lot;

          return {
            ...lot,
            price: data.price,
          };
        });

        state = {
          ...state,
          lots: updatedLots,
        };

        renderView(state);
      }

      api.get('/lots').then((lots) => {
        state = {
          ...state,
          lots,
        };

        renderView(state);

        state.lots.forEach((lot) => {
          stream.subscribe(`price-${lot.id}`, onPrice);
        });
      });
    </script>
  </body>
</html>
