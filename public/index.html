<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
      name="viewport"
    />
    <meta content="ie=edge" http-equiv="X-UA-Compatible" />
    <link href="style.css" rel="stylesheet" />
    <title>What is React</title>
  </head>
  <body>
    <div id="root"></div>

    <script>
      const api = {
        get(url) {
          switch (url) {
            case '/lots': {
              return new Promise((resolve) => {
                setTimeout(() => {
                  const demoLots = [
                    {
                      id: 1,
                      title: 'Apple',
                      price: 16,
                      description: 'Apple description',
                    },
                    {
                      id: 2,
                      title: 'Orange',
                      price: 41,
                      description: 'Orange description',
                    },
                  ];

                  resolve(demoLots);
                }, 1000);
              });
            }
          }
        },
      };

      const stream = {
        subscribe(channel, callback) {
          const match = /price-(\d+)/.exec(channel);
          if (match) {
            setInterval(() => {
              const id = parseInt(match[1]);
              const price = Math.floor(Math.random() * 100);

              callback({ id, price });
            }, 2000);
          }
        },
      };

      // ===========================

      let state = {
        time: new Date(),
        lots: null,
      };

      // ===========================

      const VDom = {
        createElement: (type, config, ...children) => {
          const props = config || {};
          const key = config ? config.key || null : null;

          if (children.length === 1) {
            props.children = children[0];
          } else {
            props.children = children;
          }

          return {
            type,
            key,
            props,
          };
        },
      };

      // ===========================

      function App({ state }) {
        return VDom.createElement('div', { className: 'app' }, [
          VDom.createElement(Header),
          VDom.createElement(Clock, { time: state.time }),
          VDom.createElement(Lots, { lots: state.lots }),
        ]);
      }

      function Header() {
        return VDom.createElement(
          'header',
          {
            className: 'header',
          },
          VDom.createElement(Logo)
        );
      }

      function Logo() {
        return VDom.createElement('img', { src: 'react.png', alt: 'logo' });
      }

      function Clock({ time }) {
        const isDay = time.getHours() > 7 && time.getHours() < 21;

        return VDom.createElement('div', { className: 'timer' }, [
          VDom.createElement('span', { className: 'value' }, [
            time.toLocaleTimeString(),
          ]),
          VDom.createElement('span', {
            className: `icon ${isDay ? 'day' : 'night'}`,
          }),
        ]);
      }

      function Lots({ lots }) {
        if (lots === null) {
          return VDom.createElement(Loader);
        }

        return VDom.createElement(
          'div',
          { className: 'lots' },
          lots.map((lot) => VDom.createElement(Lot, { lot, key: lot.id }))
        );
      }

      function Lot({ lot, key }) {
        return VDom.createElement('section', { className: 'lot', key }, [
          VDom.createElement('h2', { className: 'lot-title' }, [
            VDom.createElement('span', null, [lot.title]),
            VDom.createElement('span', null, [lot.price]),
          ]),
          VDom.createElement('p', null, [lot.description]),
        ]);
      }

      function Loader() {
        return VDom.createElement('div', { className: 'loader' }, 'Loading...');
      }

      // ===========================

      function renderView(state) {
        render(
          VDom.createElement(App, { state }),
          document.getElementById('root')
        );
      }

      renderView(state);

      // ===========================

      setInterval(() => {
        state = {
          ...state,
          time: new Date(),
        };

        renderView(state);
      }, 1000);

      function onPrice(data) {
        const updatedLots = state.lots.map((lot) => {
          if (lot.id !== data.id) return lot;

          return {
            ...lot,
            price: data.price,
          };
        });

        state = {
          ...state,
          lots: updatedLots,
        };

        renderView(state);
      }

      api.get('/lots').then((lots) => {
        state = {
          ...state,
          lots,
        };

        renderView(state);

        state.lots.forEach((lot) => {
          stream.subscribe(`price-${lot.id}`, onPrice);
        });
      });

      // ===========================

      function render(virtualDom, realDomRoot) {
        const evaluatedVirtualDom = evaluate(virtualDom);

        const virtualDomRoot = {
          type: realDomRoot.tagName.toLowerCase(),
          props: {
            ...realDomRoot.attributes,
            id: realDomRoot.id,
            children: [evaluatedVirtualDom],
          },
        };

        sync(virtualDomRoot, realDomRoot);
      }

      function evaluate(virtualNode) {
        if (typeof virtualNode !== 'object') {
          return virtualNode;
        }

        if (typeof virtualNode.type === 'function') {
          return evaluate(virtualNode.type(virtualNode.props));
        }

        const props = virtualNode.props ?? {};
        const children = Array.isArray(props.children)
          ? props.children.map(evaluate)
          : [evaluate(props.children)];

        return {
          ...virtualNode,
          props: {
            ...props,
            children,
          },
        };
      }

      function sync(virtualNode, realNode) {
        // Sync node
        if (virtualNode.props) {
          Object.entries(virtualNode.props).forEach(([name, value]) => {
            if (name === 'children' && name === 'key') return;

            if (realNode[name] !== value) {
              realNode[name] = value;
            }
          });
        }

        if (virtualNode.key) {
          realNode.dataset.key = virtualNode.key;
        }

        if (
          typeof virtualNode !== 'object' &&
          virtualNode !== realNode.nodeValue
        ) {
          realNode.nodeValue = virtualNode;
        }

        // Sync child nodes
        const realDomChildren = realNode.childNodes;
        const virtualDomChildren = virtualNode.props
          ? virtualNode.props.children || []
          : [];

        for (
          let i = 0;
          i < virtualDomChildren.length || i < realDomChildren.length;
          i++
        ) {
          const virtual = virtualDomChildren[i];
          const real = realDomChildren[i];

          const realTagName = (real?.tagName || '').toLowerCase();
          const virtualType = virtual?.type || '';

          // Remove
          if (!virtual && real) {
            realNode.remove(real);
          }

          // Update
          if (real && virtual && virtualType === realTagName) {
            sync(virtual, real);
          }

          // Replace
          if (real && virtual && virtualType !== realTagName) {
            const newRealNode = createRealNodeByVirtual(virtual);
            sync(virtual, newRealNode);
            realNode.replaceChild(newRealNode, real);
          }

          // Add
          if (virtual && !real) {
            const newRealNode = createRealNodeByVirtual(virtual);
            sync(virtual, newRealNode);
            realNode.append(newRealNode);
          }
        }
      }

      function createRealNodeByVirtual(virtual) {
        if (typeof virtual !== 'object') {
          return document.createTextNode('');
        }

        return document.createElement(virtual.type);
      }
    </script>
  </body>
</html>
